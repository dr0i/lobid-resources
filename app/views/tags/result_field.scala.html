@* Copyright 2014 Fabian Steeg, hbz. Licensed under the Eclipse Public License 1.0 *@
@(label: String, property: String, doc: play.api.libs.json.JsValue, row: views.TableRow, node: Option[play.api.libs.json.JsValue] = None, valueLabel: Option[Seq[String]] = None)

@import play.api.libs.json._
@import views.TagHelper

@string(value: JsValue) = @{ value.asOpt[String].getOrElse("--") }
@jsonVal(p: String) = @{ node match {
  case Some(node) => node
  case None => if ((doc \\ p).isEmpty) (doc \ p) else (doc \\ p).head
	}
}
@multiSingleOrEmptySeq(value: JsValue) = @{
	val jsVal = jsonVal(property)
	value match {
		case o:JsObject => Seq(o \ "@id")
		case a:JsArray => a.as[Seq[JsValue]].map(_ match {case o:JsObject => o \ "@id"; case o@_ => o})
		case _ => if(value.asOpt[String].isDefined) Seq(jsonVal(property)) else Seq()
	}
}
@row match {
  case views.TableRow.VALUES => {
    @for(elem <- multiSingleOrEmptySeq(jsonVal(property)).sortBy(_.toString)(Ordering[String].reverse) if !elem.toString.contains("http://dewey.info")) {
      <tr>
        <td>@property match {
          case _ => {@label}
        }</td>
        <td property="@property">
            @valueLabel match {
                          case None => {@string(elem)}
                          case Some(seq) => {
                            @defining(TagHelper.valueFor(doc, elem.as[String], seq)){ value =>
                            @if(value.startsWith("http://purl.org/lobid/nwbib")){
                              @defining(controllers.nwbib.Application.CLASSIFICATION.ids(value, "")){c=>
                                <a title="Nach weiteren Titeln suchen" href="@nwbib.routes.Application.search("\""+string(elem)+"\"")">
                                    @if(label!=null){@c.findValue("label").textValue() (@c.findValue("value").textValue().drop(1))} else {@value}</a>  |
                              }
                            } else {<a title="Nach weiteren Titeln suchen" href="@nwbib.routes.Application.search("\""+string(elem)+"\"")">@value</a> |}
                            <a title="Linked-Data-Quelle abrufen" href="@string(elem)"><span class="glyphicon glyphicon-link"></span></a>
                            }
                          }
                       }
        </td>
      </tr>
    }
  }
  case views.TableRow.LINKS => {
    @for(elem <- multiSingleOrEmptySeq(jsonVal(property)) if !elem.toString.contains("http://lobid.org/resource/NWBib")) {
      <tr>
        <td>@label</td>
        <td>
          @defining(string(elem)) { url => <a title="@url" rel="@property" href="@url">@url</a> }
        </td>
      </tr>
    }
  }
}
