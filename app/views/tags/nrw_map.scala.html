@* Copyright 2014 Fabian Steeg, hbz. Licensed under the GPLv2 *@

@()
<div id="map" class="pull-right">
<script src="@controllers.routes.Assets.at("javascripts/d3.v3.min.js")"></script>
<script src="@controllers.routes.Assets.at("javascripts/topojson.v1.min.js")"></script>
<script src="@controllers.routes.Assets.at("javascripts/datamaps.world.min.js")"></script>
<script>
var map = new Datamap({
    element: document.getElementById('map'),
    geographyConfig: {
        dataUrl: '@controllers.routes.Assets.at("data/nrw.topo.json")',
        borderWidth: 1,
        borderColor: '#303030',
        highlightFillColor: '#EBEBEB',
        highlightBorderColor: '#303030',
        highlightBorderWidth: 1
    },
    fills: {
        defaultFill: '#1ABD66',
        westfalen: '#FF333B'
    },
    data : {
        "05554": {fillKey: "westfalen"},
        "05562": {fillKey: "westfalen"},
        "05512": {fillKey: "westfalen"},
        "05513": {fillKey: "westfalen"},
        "05916": {fillKey: "westfalen"},
        "05911": {fillKey: "westfalen"},
        "05954": {fillKey: "westfalen"},
        "05962": {fillKey: "westfalen"},
        "05966": {fillKey: "westfalen"},
        "05970": {fillKey: "westfalen"},
        "05566": {fillKey: "westfalen"},
        "05558": {fillKey: "westfalen"},
        "05515": {fillKey: "westfalen"},
        "05978": {fillKey: "westfalen"},
        "05913": {fillKey: "westfalen"},
        "05914": {fillKey: "westfalen"},
        "05958": {fillKey: "westfalen"},
        "05974": {fillKey: "westfalen"},
        "05570": {fillKey: "westfalen"},
        "05774": {fillKey: "westfalen"},
        "05915": {fillKey: "westfalen"},
        "05754": {fillKey: "westfalen"},
        "05711": {fillKey: "westfalen"},
        "05758": {fillKey: "westfalen"},
        "05770": {fillKey: "westfalen"},
        "05766": {fillKey: "westfalen"},
        "05762": {fillKey: "westfalen"}
    },
    scope: 'nrw',
    setProjection: function(element) {
        var projection = d3.geo.mercator()
            .center([7.7, 51.4])
            .scale(6000)
            .translate([element.offsetWidth / 2, element.offsetHeight / 2]);
        var path = d3.geo.path().projection(projection);
        return {path: path, projection: projection};
    },
    done: function(datamap) {
        datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography) {
            window.location = "/nwbib/search?" + 
              "location=" + encodeURIComponent(geography.properties.name) 
              + "|" + transform(geography.geometry.coordinates[0]);
        });
    }
});
function transform(coordinates) {
    var result = '';
    var flat = [];
    /* flatten multiple nested polygons into a single polygon if required: */
    flat = typeof coordinates[0][0] == 'number' ? coordinates : flat.concat.apply(flat, coordinates);
    for(var i = 0; i < flat.length; i++) {
        var lon = flat[i][0];
        var lat = flat[i][1];
        /* use one decimal digit precision to avoid too large URL: */
        result += lat.toFixed(1) + "," + lon.toFixed(1) + " ";
    }
    return result.trim().replace(' ', '+');
}
</script>
</div>