@* Copyright 2014 Fabian Steeg, hbz. Licensed under the GPLv2 *@

@(hitId: Int, items: Map[String,List[String]])

@import play.api.libs.ws.WS
@import play.api.libs.json.JsArray
@import play.api.libs.json.Json
@import play.api.libs.json.JsValue
@import scala.concurrent._
@import ExecutionContext.Implicits.global
@import scala.concurrent.duration._
@import play.api.Play.current
@import controllers.nwbib.Application

@string(value: JsValue) = { @value.asOpt[String].getOrElse("--") }

    <link rel="stylesheet" href="@controllers.routes.Assets.at("stylesheets/leaflet.css")" />
    <script src="@controllers.routes.Assets.at("javascripts/leaflet.js")"></script>
    <script src="@controllers.routes.Assets.at("javascripts/Leaflet.MakiMarkers.js")"></script>
    @*<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.4"></script>*@
    <table class="table table-striped table-condensed">
        <tr>
            <th style="width: 30%"/>
            <th style="width: 70%"/>
        </tr>
    </table>
    <p>
    <div class="map" id="map-@(hitId)"></div>
    </p>
    <table id="table-@(hitId)" class="table table-striped table-condensed">
    </table>
    <script>
    // Some alternative tiles:
    //var layer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    //var layer = L.tileLayer('http://{s}.www.toolserver.org/tiles/germany/{z}/{x}/{y}.png');
    //var layer0 = new L.StamenTileLayer("watercolor"); // include script above, add both layers
    //var layer1 = L.tileLayer('http://a.www.toolserver.org/tiles/osm-labels-de/{z}/{x}/{y}.png');

    var layer = L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png', {
        subdomains: '1234'
    });
    var nrw = new L.LatLng(51.50, 7.8)
    var map@(hitId) = new L.Map("map-@(hitId)", {
        center: nrw,
        zoom: 7,
        scrollWheelZoom: true,
        attributionControl: false
    });
    var markerCount@(hitId) = 0;
    var tableDetails@(hitId) = '';
    var allTableDetails@(hitId) = '';
    var markers@(hitId) = {};
    @markers(items)
    $('#table-@(hitId)').append(allTableDetails@(hitId));
    map@(hitId).addLayer(layer);
    </script>

@markers(items: Map[String,List[String]]) = {
    @for((key,i) <- items.keySet.toList.sortWith((k1:String,k2:String)=>controllers.nwbib.Lobid.compareIsil(k1,k2)).zipWithIndex;
        owner = Application.CONFIG.getString("orgs.api")+"/"+key;
        response = Await.result(WS.url(owner).get(), 5.second);
        json = if(response.status == play.mvc.Http.Status.OK) response.json else Json.obj();
        ownerUrl = if((json\\"url").isEmpty) owner else (json\\"url")(0).as[String];
        ownerName = if((json\\"name").isEmpty) "" else (json\\"name")(0).as[String]) {

          var details = '<tr><td><b>Bibliothek:</b></td><td>'+
            '<b>@if(!ownerName.isEmpty){<a href="@ownerUrl">@ownerName</a>}else{&lt;Keine Angabe&gt;}</b></td></tr>'
            @defining(controllers.nwbib.Lobid.opacUrl(items(key).head)){ opacLink =>
              @if(opacLink!=null){+'<tr><td>Verf√ºgbarkeit:</td>'+'<td><a href="@opacLink">Lokalen Katalog abfragen</a></td></tr>'};
            }
          tableDetails@(hitId) = details;
          if(allTableDetails@(hitId)=='')
            allTableDetails@(hitId) += tableDetails@(hitId);
          else
            allTableDetails@(hitId) += '<tr><th style="width: 30%"/><th style="width: 70%"/></tr>' + tableDetails@(hitId);
        @for((item,i) <- items(key).zipWithIndex;
            requestUri = item+"?format=full";
            jsonFuture = WS.url(requestUri).get().map(x=>x.json);
            itemJson = Await.result(jsonFuture, 5.second);
            owners = (itemJson\\"owner");
            if(!owners.isEmpty);
            signatures = (itemJson\\"callNumber");
            signature = if(signatures.isEmpty) "" else signatures(0).as[String]) {

              var sig = '<tr><td>Signatur:</td>'+
                '<td>@if(!signature.isEmpty){<a href="@item">@signature</a>}else{&lt;Keine Angabe&gt;}</td></tr>';
              tableDetails@(hitId) += sig;
              allTableDetails@(hitId) += sig;
        }
        @if(
        !(json \\ "lon").isEmpty && (json \\ "lon").head.asOpt[String].isDefined &&
        !(json \\ "lat").isEmpty && (json \\ "lat").head.asOpt[String].isDefined) {
            @defining(hitId+"_"+i) { id =>
                var lat = @string((json \\ "lat").head)
                var lon = @string((json \\ "lon").head)
                var latlng@(id) = L.latLng(lat, lon);
                var icon@(id) = L.MakiMarkers.icon({icon: "library", color: "#FF333B", size: "m"});
                var marker@(id) = L.marker([lat, lon],{
                    title: "@ownerName (@key)",
                    icon: icon@(id)
                });
                markers@(hitId)[latlng@(id).toString()] = marker@(id);
                bindPopup@(id)(tableDetails@(hitId));
                marker@(id).on('click', function(e) {
                    zoomDetails@(id)();
                });
                marker@(id).on('popupclose', function(e) {
                    map@(hitId).setView(nrw, 7);
                });
                marker@(id).addTo(map@(hitId));
                markerCount@(hitId)++;
                if(@items.size == 1){
                    bindPopup@(id)(allTableDetails@(hitId));
                    zoomDetails@(id)();
                }
                function zoomDetails@(id)() {
                    map@(hitId).setView(latlng@(id), 16);
                    marker@(id).openPopup();
                }
                function bindPopup@(id)(content) {
                    marker@(id).bindPopup(
                    '<table class="table-striped table-condensed">'+
                        content+
                    '</table>',
                    {
                        keepInView: true
                    });
                }
            }
        }
    }
}
