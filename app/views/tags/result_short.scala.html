@* Copyright 2014 Fabian Steeg, hbz. Licensed under the GPLv2 *@

@(id:String, doc: play.api.libs.json.JsValue, docType: String = "")

@import play.api.libs.json._
@import views.TableRow
@import controllers.nwbib.Lobid
@import scala.collection.immutable.Map

@optional(doc: JsValue, key: String, sep: String, alt: String)=@{
    val other = (doc \\ key)
    if(!other.isEmpty){
        sep + other(0).asOpt[String].getOrElse(other(0).as[Seq[JsValue]].map(_.as[String]).mkString("; "))
    } else {alt}
}

@valueFor(doc: JsValue, id: String, keys: Seq[String]) = @{
    val res = for (elem <- ((doc \\ "@graph").head).as[Seq[JsValue]]; key <- keys;
        if ((elem \ "@id").as[String] == id && elem.as[Map[String, JsValue]].contains(key))
    ) yield {
        val result = (elem \ key)
        result.asOpt[String].getOrElse(result.toString)
    }
    if(res.isEmpty) id else res.get(0)
}

@gndEntities = @{ 
	Option(Seq(
	    "preferredName",
	    "preferredNameForTheWork",
	    "preferredNameForTheFamily",
	    "preferredNameForThePerson",
	    "preferredNameForTheCorporateBody",
	    "preferredNameForTheSubjectHeading",
	    "preferredNameForTheConferenceOrEvent",
	    "preferredNameForThePlaceOrGeographicName"))
}

@label(keys: Seq[String])={
    @defining(keys.find(s=>(doc\\s).size>0)){key=>
        <td style="text-align: right">
        @if(!key.isEmpty) {
            @defining((doc\\key.get)){hits=>
                 @valueFor(doc, hits.get(0).asOpt[String].getOrElse(hits.get(0).as[Seq[String]].get(0)), gndEntities.get)
                 @if(hits.get(0).asOpt[Seq[String]].getOrElse(Seq()).size>1){ <i>et al.</i> }
            }
        }
        </td>
    }
}

@defining(if(!docType.isEmpty){Seq(docType)}else{(doc\\"@type").last.asOpt[Seq[String]].getOrElse(Seq((doc\\"@type").last.asOpt[String].get))}){t=>
<tr>
  <td> <span title="@Lobid.typeLabel(t)" class="@Lobid.typeIcon(t)"></span> </td>
  <td> <a href="@nwbib.routes.Application.show(id)">
    @optional(doc, "title", "", "<Kein Titel>")
    @optional(doc, "otherTitleInformation", " | ", "")
    @optional(doc, "edition", " | ", "")</a></td>
  @label(Seq("creator", "editor", "contributor", "statementOfResponsibility"))
  <td style="text-align: right"> @optional(doc, "issued", "", "").split("[,;]")(0) </td>
  <td style="text-align: right"> @tags.star_button(id) </td>
</tr>
}