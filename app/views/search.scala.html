@* Copyright 2014 Fabian Steeg, hbz. Licensed under the Eclipse Public License 1.0 *@

@(config: com.typesafe.config.Config, result: String, q:String, from: Int, size: Int, allHits: Long, owner: String, t: String)

@import helper._
@import controllers.nwbib.Lobid
@import play.api.libs.json.Json
@import play.api.libs.json.JsValue
@import play.api.libs.json.JsArray

@pagination(hits:Int)={
    <ul class="pagination">
      <li class="previous @if(from==0){disabled}">
        <a href="@if(from==0){#} else {@nwbib.routes.Application.search(q,from-size,size,owner,t)}">&larr; Vorige</a>
      </li>
      <li class="disabled"><a href="#">@if(hits>0){@(from+1) bis @(Math.min(from+hits,from+size))@if(allHits>0){ von @allHits}}else{0 Treffer}</a></li>
      <li class="next @if(from+hits < from+size){disabled}">
        <a href="@if(from+hits < from+size){#} else {@nwbib.routes.Application.search(q,from+size,size,owner,t)}">N채chste &rarr;</a>
      </li>
      &nbsp;
      @facets
    </ul>
}

@facets()={
    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          Typ: @if(t.isEmpty){Alle} else {@Lobid.typeLabel(t) <span class="@Lobid.typeIcon(Arrays.asList(t))"></span>}
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" id="facets-ul">
          <li @if(t==""){class="active"}>
            <script>
            $.ajax({
              url: '/nwbib/facets?q=@q&&from=@from&size=@size&owner=@owner&t=@t&field=@@graph.@@type',
              success: function(data, textStatus, jqXHR) {
                $("#facets-ul").append(data);
                $("#facets-loading").remove();
              },
              error: function(jqXHR, textStatus, errorThrown) {
                console.log(textStatus);
              }
            });
            </script>
            <a href="@nwbib.routes.Application.search(q,from,size,owner)">Alle Typen</a></li>
            <li id="facets-loading"><a href="#">Lade Facetten...</a></li>
        </ul>
    </div>
    
    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          Bestandsfilter: @if(owner=="all"){<span class="octicon octicon-x"></span>} else { 
                   @if(owner=="*") { <span class="octicon octicon-check"></span>} else {
                     @owner.split(",").size Einrichtung@if(owner.split(",").size>1){en}}
                   }
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li @if(owner=="all"){class="active"}><a href="@nwbib.routes.Application.search(q,from,size, "all",t)">Alle zeigen</a></li>
          <li @if(owner == "*"){class="active"}><a href="@nwbib.routes.Application.search(q,from,size, "*",t)">Mit Bestand</a></li>
          @defining(owner.replace("*","").trim.split(",").filterNot(s => {s.isEmpty || s == "all"})) { os =>
              @if(!os.isEmpty){
                <li class="divider"></li>
                <li role="presentation" class="dropdown-header">Mit Bestand in Einrichtung:</li>
              }
              @for(o <- os) {
                <li class="active">
                    <a href="@nwbib.routes.Application.search(q,from,size,if(os.size==1) "all" else os.filter(_!=o).mkString(","),t)">
                        <span class="glyphicon glyphicon-remove-sign"></span> &nbsp;
                        @Lobid.organisationLabel(o)
                    </a>
                </li>
              }
          }
        </ul>
        <ul class="nav nav-pills pull-right">
          <li>
            <form class="form-inline" action="/nwbib/search" method="GET" name="addOwnerForm">
                &nbsp;
                <input type="text" class="owner form-control" id="owner" name="owner" 
                    placeholder="Bestandsfilter f체r Einrichtung hinzuf체gen"/>
                <button class="btn btn-link" onclick="addOwnerFun()" id="addOwner">
                    <span class="glyphicon glyphicon-plus-sign"></span></button>
                <input type="hidden" name="query" value="@q"/>
                <input type="hidden" name="from" value="@from"/>
                <input type="hidden" name="size" value="@size"/>
                <input type="hidden" name="t" value="@t"/>
            </form>
          </li>
          <script>
          function addOwnerFun() {
            @if(owner!="all" && owner!="*"){
              var newOwner =  document.getElementById('owner').value;
              var oldOwner = '@owner';
              document.getElementById('owner').style.color = 'white';
              var found = $.inArray(newOwner, oldOwner.split(",")) > -1;
              if(!found){
                document.getElementById('owner').value = oldOwner + ',' + newOwner;
              } else {
                document.getElementById('owner').value = oldOwner;
              }
            }
            document.addOwnerForm.submit();
          }
          </script>
          <script>
            $('input#owner').each(function() {
                var $input = $(this);
                $input.autocomplete({
                    source : function(request, response) {
                        $.ajax({
                            url : "http://api.lobid.org/organisation",
                            dataType : "jsonp",
                            data : {
                                name : request.term,
                                format : "ids"
                            },
                            success : function(data) {
                                response(data);
                            }
                        });
                    }
                });
            });
          </script>
        </ul>
    </div>
}

@optional(doc: JsValue, key: String, sep: String, alt: String)={
    @defining((doc \\ key)) { other =>
      @if(!other.isEmpty){
        @sep@(other(0).asOpt[String].getOrElse(other(0).as[Seq[JsValue]].map(_.as[String]).mkString("; ")))
      } else {@alt}
    }
}

@main("NWBib") {
    @tags.search_form(q)
    @defining(Json.parse(result).asOpt[Seq[JsValue]].getOrElse(Seq()).zipWithIndex.drop(1)) { hits =>
        @pagination(hits.size)
        <table class="table table-striped table-condensed">
        <tr>
          <th style="width: 5%"></th>
          <th style="width: 85%"></th>
          <th style="width: 10%; text-align: right"></th>
        </tr>
        @for((doc,i) <- hits; t = (doc\\"@type").last.asOpt[Seq[String]].getOrElse(Seq((doc\\"@type").last.asOpt[String].get))) {
            <tr>
              <td> <span class="@Lobid.typeIcon(t)"></span> </td>
              <td> <a href="@nwbib.routes.Application.show(((doc \ "@id").as[String].split("/")(4)))">
                @optional(doc, "title", "", "<Kein Titel>") @optional(doc, "otherTitleInformation", " | ", "")</a></td>
              <td style="text-align: right"> @optional(doc, "issued", "", "") </td>
            </tr>
        }
        </table>
        @if(flash.get("error")!=null){
            <div class="alert alert-danger">@flash.get("error")</div>
        } else {
            @if(hits.isEmpty && !q.trim.isEmpty){
                <div class="alert alert-info">
                    Keine Ergebnisse@if(owner!="all"){ <code>mit Bestand</code>} f체r Auswahl und Anfrage <code>@q</code>
                    @if(owner!="all" || !q.endsWith("~")){ Versuchen Sie }
                    @if(owner!="all"){
                     andere Filtereinstellungen 
                     @if(!q.endsWith("~")){ oder eine }
                    }
                    @if(!q.endsWith("~")){
                        <code><a href="@nwbib.routes.Application.search(q+"~",from,size)">unscharfe Suche</a></code>
                    }
                </div>
            }
        }
        @if(hits.isEmpty && q.trim.isEmpty){
            @tags.nrw_map()
        }
    }
}
