@* Copyright 2014 Fabian Steeg, hbz. Licensed under the Eclipse Public License 1.0 *@

@(config: com.typesafe.config.Config, result: String, q:String, from: Int, size: Int, allHits: Long, all: Boolean, t: String)

@import helper._
@import controllers.nwbib.Lobid
@import play.api.libs.json.Json
@import play.api.libs.json.JsValue
@import play.api.libs.json.JsArray

@pagination(hits:Int)={
    @if(hits!=0){
    <ul class="nav nav-pills pull-right">
      <li @if(all==true){class="active"}><a href="@nwbib.routes.Application.search(q,from,size, true, t)">Alle</a></li>
      <li @if(all!=true){class="active"}><a href="@nwbib.routes.Application.search(q,from,size, false, t)">Mit Bestand</a></li>
    </ul>
    <ul class="pagination">
      <li class="previous @if(from==0){disabled}">
        <a href="@if(from==0){#} else {@nwbib.routes.Application.search(q,from-size,size,all)}">&larr; Vorige</a>
      </li>
      <li class="disabled"><a href="#">@(from+1) bis @(Math.min(from+hits,from+size))@if(allHits>0){ von @allHits}</a></li>
      <li class="next @if(from+hits < from+size){disabled}">
        <a href="@if(from+hits < from+size){#} else {@nwbib.routes.Application.search(q,from+size,size,all)}">Nächste &rarr;</a>
      </li>
      &nbsp;
      @facets
    </ul>
    }
}

@facets()={
    <div class="btn-group"> 
    @defining(controllers.nwbib.Lobid.getFacets(q, all, "@graph.@type").get(5000).facet("@graph.@type")
        .asInstanceOf[org.elasticsearch.search.facet.terms.TermsFacet].getEntries.drop(3)){ entries =>
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          Typ: @if(t.isEmpty){Alle} else {@Lobid.typeLabel(t)}
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li @if(t==""){class="active"}>
            <a href="@nwbib.routes.Application.search(q,from,size, all)">Alle Typen</a></li>
            @for(e <- entries) {
                <li @if(t==e.getTerm().toString){class="active"}>
                <a href="@nwbib.routes.Application.search(q,from,size, all,e.getTerm().toString)">
                <span class="@Lobid.typeIcon(Arrays.asList(e.getTerm().toString))"></span> &nbsp;
                @Lobid.typeLabel(e.getTerm().toString) (@e.getCount())</a>
                </li>
            }
        </ul>
      }
    </div>
}

@optional(doc: JsValue, key: String, sep: String)={
    @defining((doc \\ key)) { other =>
      @if(!other.isEmpty){
        @sep@(other(0).asOpt[String].getOrElse(other(0).as[Seq[JsValue]].map(_.as[String]).mkString("; ")))
      }
    }
}

@main("NWBib") {
    @tags.search_form(q)
    @defining(Json.parse(result).asOpt[Seq[JsValue]].getOrElse(Seq()).zipWithIndex.drop(1)) { hits =>
        @pagination(hits.size)
        <table class="table table-striped table-condensed">
        <tr>
          <th style="width: 5%"></th>
          <th style="width: 85%"></th>
          <th style="width: 10%; text-align: right"></th>
        </tr>
        @for((doc,i) <- hits) {
            <tr>
              <td> <span class="@Lobid.typeIcon((doc\\"@type").last.as[Seq[String]])"></span> </td>
              <td> <a href="@nwbib.routes.Application.show(((doc \ "@id").as[String].split("/")(4)))">
                @optional(doc, "title", "") @optional(doc, "otherTitleInformation", " | ")</a></td>
              <td style="text-align: right"> @optional(doc, "issued", "") </td>
            </tr>
        }
        </table>
        @if(flash.get("error")!=null){
            <div class="alert alert-danger">@flash.get("error")</div>
        } else {
            @if(hits.isEmpty && !q.trim.isEmpty){
                <div class="alert alert-info">
                    Keine Ergebnisse@if(!all){ <code>mit Bestand</code>} für <code>@q</code>
                    @if(!all || !q.endsWith("~")){ Versuchen Sie eine }
                    @if(!all){
                     Suche nach Titeln 
                     <code><a href="@nwbib.routes.Application.search(q,from,size,true)">ohne Bestand</a></code>
                     @if(!q.endsWith("~")){ oder eine }
                    }
                    @if(!q.endsWith("~")){
                        <code><a href="@nwbib.routes.Application.search(q+"~",from,size)">unscharfe Suche</a></code>
                    }
                </div>
            }
        }
        @if(hits.isEmpty && q.trim.isEmpty){
            @tags.nrw_map()
        }
    }
}
