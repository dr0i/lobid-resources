@* Copyright 2014 Fabian Steeg, hbz. Licensed under the Eclipse Public License 1.0 *@

@(config: com.typesafe.config.Config, result: String, q:String, author:String, name:String, subject:String, id:String, publisher:String, issued:String, medium: String, nwbibspatial: String, nwbibsubject: String, from: Int, size: Int, allHits: Long, owner: String, t: String, sortParam: String)

@import helper._
@import controllers.nwbib.Lobid
@import controllers.nwbib.Application
@import play.api.libs.json.Json
@import play.api.libs.json.JsValue
@import play.api.libs.json.JsArray

@pagination(hits:Int)={
    <ul class="pagination fill">
      <li class="previous @if(from==0){disabled}">
        <a href="@if(from==0){#} else {@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from-size,size,owner,t,sortParam)}">&larr;</a>
      </li>
      <li class="disabled">
      <a style="width:200px; text-align: center;" href="#">@if(hits>0){@(from+1) bis @(Math.min(from+hits,from+size))@if(allHits>0){ von @allHits}}else{0 Treffer}</a>
      </li>
      <li class="next @if(from+hits < from+size){disabled}">
        <a href="@if(from+hits < from+size){#} else {@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from+size,size,owner,t,sortParam)}">&rarr;</a>
      </li>
    </ul>
}

@facets(facet: String, field: String, current: String, allLabel:String = "Alle")={
	    <div class="btn-group fill">
	        <button type="button" class="btn btn-default dropdown-toggle fill" data-toggle="dropdown">
	          @if(current.isEmpty()){@facet: @allLabel} else {@Lobid.facetLabel(Seq(current), field) <span class="@Lobid.facetIcon(Arrays.asList(current), field)"></span>}
	          <span class="caret"></span>
	        </button>
	        <ul class="dropdown-menu scrollable-menu" id="facets-ul-@field.hashCode.abs">
	          <li @if(current==""){class="active"}>
	            <script>
	            $.ajax({
	              url: '/nwbib/facets?q=@urlEncode(q)&author=@urlEncode(author)&name=@urlEncode(name)&subject=@urlEncode(subject)&publisher=@urlEncode(publisher)&issued=@urlEncode(issued)&medium=@urlEncode(medium)&nwbibspatial=@urlEncode(nwbibspatial)&nwbibsubject=@urlEncode(nwbibsubject)&from=@from&size=@size&owner=@urlEncode(owner)&t=@urlEncode(t)&field=@urlEncode(field)&sort=@urlEncode(sortParam)',
	              success: function(data, textStatus, jqXHR) {
	                $("#facets-ul-@field.hashCode.abs").append(data);
	                $("#facets-loading-@field.hashCode.abs").remove();
	              },
	              error: function(jqXHR, textStatus, errorThrown) {
	                console.log(textStatus);
	              }
	            });
	            </script>
	            <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,if (medium==current) "" else medium,nwbibspatial,nwbibsubject,from,size,if (owner==current) "" else owner,if (t==current) "" else t,sortParam)">@facet: @allLabel</a></li>
	            <li id="facets-loading-@field.hashCode.abs"><a href="#">Lade Facetten...</a></li>
	        </ul>
	    </div>
}

@sort()={
        <div class="btn-group fill">
            <button type="button" class="btn btn-default dropdown-toggle fill" data-toggle="dropdown">
              Sortierung: @sortParam match {
                case "" => { Relevanz }
                case "newest" => { Neueste }
                case "oldest" => { Älteste }
              }
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="facets-ul">
              <li @if(sortParam==""){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from,size,owner,t,"")">Relevanz</a>
              </li>
              <li @if(sortParam=="newest"){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from,size,owner,t,"newest")">Neueste zuerst</a>
              </li>
              <li @if(sortParam=="oldest"){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from,size,owner,t,"oldest")">Älteste zuerst</a>
              </li>
            </ul>
        </div>
}

@main("NWBib - Ergebnisliste") {
    @if(Seq(author,name,subject,id,publisher,issued,nwbibspatial,nwbibsubject).exists(!_.isEmpty)){
      @tags.search_advanced("Suche aktualisieren", q, author, name, subject, nwbibspatial, nwbibsubject, id, publisher, issued, sortParam)
    } else {
      @tags.search_form(q)
    }
    @defining(Json.parse(result).asOpt[Seq[JsValue]].getOrElse(Seq()).zipWithIndex.drop(1)) { hits =>
        <div class="row pagination-and-facets">
	        <div class="col col-md-3">@pagination(hits.size)</div>
	        <div class="col col-md-2">@facets("Publikationstyp", Application.TYPE_FIELD, t)</div>
	        <div class="col col-md-2">@facets("Medium", Application.MEDIUM_FIELD, medium)</div>
	        <div class="col col-md-2">@sort</div>
	        <div class="col col-md-3">@facets("Bestand", Application.ITEM_FIELD, owner, "mit und ohne Bestand")</div>
        </div>
        <table class="table table-striped table-condensed">
        <tr>
          <th style="width: 5%"></th>
          <th style="width: 60%"></th>
          <th style="width: 25%; text-align: right"></th>
          <th style="width: 5%; text-align: right"></th>
          <th style="width: 5%; text-align: right"></th>
        </tr>
        @for((doc,i) <- hits; id = ((doc \ "@id").as[String].split("/")(4))) {
            @tags.result_short(id,doc)
        }
        </table>
        @if(flash.get("error")!=null){
            <div class="alert alert-danger">@flash.get("error")</div>
        } else {
            @if(hits.isEmpty){
                <div class="alert alert-info text-center">
                    Keine Ergebnisse für Auswahl und Anfrage. Versuchen Sie eine andere Anfrage oder andere Filtereinstellungen.
                </div>
            }
        }
    }
}
