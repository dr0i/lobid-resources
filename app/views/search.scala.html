@* Copyright 2014 Fabian Steeg, hbz. Licensed under the Eclipse Public License 1.0 *@

@(config: com.typesafe.config.Config, result: String, q:String, author:String, name:String, subject:String, id:String, publisher:String, issued:String, medium: String, from: Int, size: Int, allHits: Long, owner: String, t: String, sortParam: String)

@import helper._
@import controllers.nwbib.Lobid
@import controllers.nwbib.Application
@import play.api.libs.json.Json
@import play.api.libs.json.JsValue
@import play.api.libs.json.JsArray

@pagination(hits:Int)={
    <ul class="pagination fill">
      <li class="previous @if(from==0){disabled}">
        <a href="@if(from==0){#} else {@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from-size,size,owner,t,sortParam)}">&larr;</a>
      </li>
      <li class="disabled">
      <a style="width:200px; text-align: center;" href="#">@if(hits>0){@(from+1) bis @(Math.min(from+hits,from+size))@if(allHits>0){ von @allHits}}else{0 Treffer}</a>
      </li>
      <li class="next @if(from+hits < from+size){disabled}">
        <a href="@if(from+hits < from+size){#} else {@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from+size,size,owner,t,sortParam)}">&rarr;</a>
      </li>
    </ul>
}

@facets(facet: String, field: String, current: String)={
	    <div class="btn-group fill">
	        <button type="button" class="btn btn-default dropdown-toggle fill" data-toggle="dropdown">
	          @facet: @if(current.isEmpty()){Alle} else {@Lobid.facetLabel(Seq(current), field) <span class="@Lobid.facetIcon(Arrays.asList(current), field)"></span>}
	          <span class="caret"></span>
	        </button>
	        <ul class="dropdown-menu" id="facets-ul-@field.hashCode.abs">
	          <li @if(current==""){class="active"}>
	            <script>
	            $.ajax({
	              url: '/nwbib/facets?q=@urlEncode(q)&author=@urlEncode(author)&name=@urlEncode(name)&subject=@urlEncode(subject)&publisher=@urlEncode(publisher)&issued=@urlEncode(issued)&medium=@urlEncode(medium)&from=@from&size=@size&owner=@urlEncode(owner)&t=@urlEncode(t)&field=@urlEncode(field)&sort=@urlEncode(sortParam)',
	              success: function(data, textStatus, jqXHR) {
	                $("#facets-ul-@field.hashCode.abs").append(data);
	                $("#facets-loading-@field.hashCode.abs").remove();
	              },
	              error: function(jqXHR, textStatus, errorThrown) {
	                console.log(textStatus);
	              }
	            });
	            </script>
	            <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,if (medium==current) "" else medium,from,size,owner,if (t==current) "" else t,sortParam)">Alle</a></li>
	            <li id="facets-loading-@field.hashCode.abs"><a href="#">Lade Facetten...</a></li>
	        </ul>
	    </div>
}
@ownersDropdown()={
	    <div class="btn-group fill">
	        <button type="button" class="btn btn-default dropdown-toggle fill" data-toggle="dropdown">
	          Filter: @if(owner=="all"){<span class="octicon octicon-x"></span>} else { 
	                   @if(owner=="*") { <span class="octicon octicon-check"></span>} else {
	                     @owner.split(",").size@* Einrichtung@if(owner.split(",").size>1){en}*@}
	                   }
	          <span class="caret"></span>
	        </button>
	        <ul class="dropdown-menu">
	          <li @if(owner=="all"){class="active"}><a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from,size, "all",t,sortParam)">Alle zeigen</a></li>
	          <li @if(owner == "*"){class="active"}><a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from,size, "*",t,sortParam)">Mit Bestand</a></li>
	          @defining(owner.replace("*","").trim.split(",").filterNot(s => {s.isEmpty || s == "all"})) { os =>
	              @if(!os.isEmpty){
	                <li class="divider"></li>
	                <li role="presentation" class="dropdown-header">Mit Bestand in Einrichtung:</li>
	              }
	              @for(o <- os) {
	                <li class="active">
	                    <a title="Filter entfernen" href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from,size,if(os.size==1) "all" else os.filter(_!=o).mkString(","),t,sortParam)">
	                        <span class="glyphicon glyphicon-remove-sign"></span> &nbsp;
	                        @Lobid.organisationLabel(o)
	                    </a>
	                </li>
	              }
	          }
	        </ul>
	    </div>
}
@ownersForm()={
            <form class="form-inline" action="/nwbib/search" method="GET" name="addOwnerForm">
                <div class="form-group fill">
	                <div class="input-group">
	                    <input type="text" class="owner form-control" id="owner" name="owner" 
	                        placeholder="Bestand in..."/>
	                    <span class="input-group-btn">
	                       <button title="Filter hinzufügen" class="btn btn-default" onclick="addOwnerFun()" id="addOwner">
                            <span class="glyphicon glyphicon-filter"></span></button>
                        </span>
	               </div>
                </div>
                <input type="hidden" name="query" value="@q"/>
                <input type="hidden" name="author" value="@author"/>
                <input type="hidden" name="name" value="@name"/>
                <input type="hidden" name="subject" value="@subject"/>
                <input type="hidden" name="from" value="@from"/>
                <input type="hidden" name="size" value="@size"/>
                <input type="hidden" name="t" value="@t"/>
           </form>
          <script>
          function addOwnerFun() {
            @if(owner!="all" && owner!="*"){
              var newOwner =  document.getElementById('owner').value;
              var oldOwner = '@owner';
              document.getElementById('owner').style.color = 'white';
              var found = $.inArray(newOwner, oldOwner.split(",")) > -1;
              if(!found){
                document.getElementById('owner').value = oldOwner + ',' + newOwner;
              } else {
                document.getElementById('owner').value = oldOwner;
              }
            }
            document.addOwnerForm.submit();
          }
          </script>
          <script>
            $('input#owner').each(function() {
                var $input = $(this);
                $input.autocomplete({
                    source : function(request, response) {
                        $.ajax({
                            url : "http://api.lobid.org/organisation",
                            dataType : "jsonp",
                            data : {
                                name : request.term,
                                format : "ids"
                            },
                            success : function(data) {
                                response(data);
                            }
                        });
                    }
                });
            });
          </script>
}
@sort()={
        <div class="btn-group fill">
            <button type="button" class="btn btn-default dropdown-toggle fill" data-toggle="dropdown">
              Sortierung: @sortParam match {
                case "" => { Relevanz }
                case "newest" => { Neueste }
                case "oldest" => { Älteste }
              }
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="facets-ul">
              <li @if(sortParam==""){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from,size,owner,t,"")">Relevanz</a>
              </li>
              <li @if(sortParam=="newest"){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from,size,owner,t,"newest")">Neueste zuerst</a>
              </li>
              <li @if(sortParam=="oldest"){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,from,size,owner,t,"oldest")">Älteste zuerst</a>
              </li>
            </ul>
        </div>
}

@main("NWBib") {
    @tags.search_advanced("Suche aktualisieren", q, author, name, subject, id, publisher, issued, sortParam)
    @defining(Json.parse(result).asOpt[Seq[JsValue]].getOrElse(Seq()).zipWithIndex.drop(1)) { hits =>
        <div class="row pagination-and-facets">
	        <div class="col col-md-3">@pagination(hits.size)</div>
	        <div class="col col-md-2">@facets("Typ", Application.TYPE_FIELD, t)</div>
	        <div class="col col-md-2">@facets("Medium", Application.MEDIUM_FIELD, medium)</div>
	        <div class="col col-md-2">@sort</div>
	        <div class="col col-md-2">@ownersForm</div>
	        <div class="col col-md-1">@ownersDropdown</div>
        </div>
        <table class="table table-striped table-condensed">
        <tr>
          <th style="width: 5%"></th>
          <th style="width: 60%"></th>
          <th style="width: 25%; text-align: right"></th>
          <th style="width: 5%; text-align: right"></th>
          <th style="width: 5%; text-align: right"></th>
        </tr>
        @for((doc,i) <- hits; id = ((doc \ "@id").as[String].split("/")(4))) {
            @tags.result_short(id,doc)
        }
        </table>
        @if(flash.get("error")!=null){
            <div class="alert alert-danger">@flash.get("error")</div>
        } else {
            @if(hits.isEmpty){
                <div class="alert alert-info text-center">
                    Keine Ergebnisse für Auswahl und Anfrage. Versuchen Sie eine andere Anfrage oder andere Filtereinstellungen.
                </div>
            }
        }
    }
}
