@* Copyright 2014 Fabian Steeg, hbz. Licensed under the GPLv2 *@

@(config: com.typesafe.config.Config, result: String, q:String, author:String, name:String, subject:String, id:String, publisher:String, issued:String, medium: String, nwbibspatial: String, nwbibsubject: String, from: Int, size: Int, allHits: Long, owner: String, t: String, sortParam: String, set: String, location: String)

@import helper._
@import controllers.nwbib.Lobid
@import controllers.nwbib.Application
@import play.api.libs.json.Json
@import play.api.libs.json.JsValue
@import play.api.libs.json.JsArray

@pagination(hits:Int)={
  <nav>
    <ul class="pager">
      <li class="previous @if(from==0){disabled}">
        <a style="width:20%; text-align: center;" href="@if(from==0){#} else {@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from-size,size,owner,t,sortParam,set=set,location=location)}">&larr;</a>
      </li>
      <li class="disabled">
      <a style="width:60%; text-align: center; white-space: nowrap;" href="#">@if(hits>0){@(from+1) bis @(Math.min(from+hits,from+size))@if(allHits>0){ von @allHits}}else{0 Treffer}</a>
      </li>
      <li class="next @if(from+size >= allHits){disabled}">
        <a style="width:20%; text-align: center;" href="@if(from+size >= allHits){#} else {@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from+size,size,owner,t,sortParam,set=set,location=location)}">&rarr;</a>
      </li>
    </ul>
  </nav>
}

@facets(facet: String, field: String, current: String, addClass:String = "", allLabel:String = "Alle")={
	    <div class="btn-group fill @addClass">
	        <button type="button" class="btn @if(!current.isEmpty()){active} btn-default dropdown-toggle fill" data-toggle="dropdown">
	          @if(current.isEmpty()){@facet: @allLabel} else {@Html(Lobid.facetLabel(Seq(current), field)) <span class="@Lobid.facetIcon(Arrays.asList(current), field)"></span>}
	          <span class="caret"></span>
	        </button>
	        <ul class="dropdown-menu scrollable-menu" id="facets-ul-@field.hashCode.abs">
	          <li @if(current==""){class="active"}>
	            <script>
	            $.ajax({
	              url: '/nwbib/facets?q=@urlEncode(q)&author=@urlEncode(author)&name=@urlEncode(name)&subject=@urlEncode(subject)&publisher=@urlEncode(publisher)&issued=@urlEncode(issued)&medium=@urlEncode(medium)&nwbibspatial=@urlEncode(nwbibspatial)&nwbibsubject=@urlEncode(nwbibsubject)&from=0&size=@size&owner=@urlEncode(owner)&t=@urlEncode(t)&field=@urlEncode(field)&sort=@urlEncode(sortParam)&set=@urlEncode(set)&location=@urlEncode(location)',
	              success: function(data, textStatus, jqXHR) {
	                $("#facets-ul-@field.hashCode.abs").append(data);
	                $("#facets-loading-@field.hashCode.abs").remove();
	              },
	              error: function(jqXHR, textStatus, errorThrown) {
	                console.log(textStatus);
	              }
	            });
	            </script>
	            <a href="@nwbib.routes.Application.search(q,author,name,if (subject==current) "" else subject,id,publisher,issued,if (medium==current) "" else medium,if(nwbibspatial==current) "" else nwbibspatial,if(nwbibsubject==current) "" else nwbibsubject,from,size,if (owner==current) "" else owner,if (t==current) "" else t,sortParam,set=set,location=location)">@facet: @allLabel</a></li>
	            <li id="facets-loading-@field.hashCode.abs"><a href="#">Lade @facet...</a></li>
	        </ul>
	    </div>
}

@sort()={
        <div class="sort">
            <ul class="nav nav-pills" role="tablist">
              <li @if(sortParam==""){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from,size,owner,t,"",set=set,location=location)">Relevanz</a>
              </li>
              <li @if(sortParam=="newest"){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from,size,owner,t,"newest",set=set,location=location)">Neueste</a>
              </li>
              <li @if(sortParam=="oldest"){class="active"}>
                <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from,size,owner,t,"oldest",set=set,location=location)">Älteste</a>
              </li>
            </ul>
        </div>
}

@main("NWBib - Ergebnisliste") {
    @if(Seq(author,name,id,publisher,issued,set).exists(!_.isEmpty)){
      @tags.search_advanced("Suche aktualisieren", q, author, name, subject, nwbibspatial, nwbibsubject, id, publisher, issued, sortParam, set=set)
    } else {
      @tags.search_form(q, location)
    }
    @defining(Json.parse(result).asOpt[Seq[JsValue]].getOrElse(Seq()).zipWithIndex.drop(1)) { hits =>
     <div class="row">
         <div class="col-md-8">
         <div class="row">
           <div class="col-md-6">@pagination(hits.size)</div>
           <div class="col-md-6">@sort</div>
         </div>
         <table class="table table-striped table-condensed">
         <tr>
          <th style="width: 5%"></th>
          <th style="width: 60%"></th>
          <th style="width: 25%; text-align: right"></th>
          <th style="width: 5%; text-align: right"></th>
          <th style="width: 5%; text-align: right"></th>
         </tr>
         @for((doc,i) <- hits; id = ("""http://.*?lobid.org/resource.+?([^/]+).*?""".r findFirstMatchIn ((doc \ "@id").as[String])).get group 1) {
            @tags.result_short(id,doc)
         }
         </table>

         @if(flash.get("error")!=null){
            <div class="alert alert-danger text-center">@flash.get("error")</div>
         } else {
            @if(hits.isEmpty){
                <div class="alert alert-info text-center">
                    Keine Ergebnisse für Auswahl und Anfrage. Versuchen Sie eine andere Anfrage oder andere Filtereinstellungen.
                </div>
            }
         }
        </div>
        <div class="col-md-4">
            <p class="lead" style="margin-top:5px">Ergebnisse eingrenzen:</p>
            <p style="padding-top:10px;"><strong>Regionen, Orte und Sachgebiete</strong></p>
            <div class="row facet"><div class="col-md-12">@facets("Sachgebiete", Application.NWBIB_SUBJECT_FIELD, nwbibsubject)</div></div>
            <div class="row facet"><div class="col-md-12">@facets("Regionen und Orte", Application.NWBIB_SPATIAL_FIELD, nwbibspatial)</div></div>
            </p>
            <p style="padding-top:10px;">
            @if(!location.isEmpty){
              <strong>Landkreis: </strong>
              <span class="label label-default">@(location.split("\\|")(0))</span> | 
              Filter entfernen: <a href="@nwbib.routes.Application.search(q,author,name,subject,id,publisher,issued,medium,nwbibspatial,nwbibsubject,from,size,owner,t,sortParam,set=set,location="")" title="Landkreis entfernen"><span class="octicon octicon-x"></span></a> 
            } else {
              <strong>Landkreise: </strong> Alle | 
              Landkreis auswählen: <a href="@nwbib.routes.Application.index" title="Landkreis auswählen"><span class="octicon octicon-globe"></span></a>
            }
            </p>
            <p style="padding-top:10px;"><strong>Schlagwörter</strong></p>
            <p>
            <div class="row facet"><div class="col-md-12">@facets("Schlagwörter", Application.SUBJECT_FIELD, subject, "dropup")</div></div>
            </p>
            <p style="padding-top:10px;"><strong>Medien- und Publikationstypen</strong></p>
            <p>
            <div class="row facet"><div class="col-md-12">@facets("Publikationstypen", Application.TYPE_FIELD, t, "dropup")</div></div>
            <div class="row facet"><div class="col-md-12">@facets("Medien", Application.MEDIUM_FIELD, medium, "dropup")</div></div>
            </p>
            <p style="padding-top:10px;"><strong>Bestand in Bibliotheken</strong></p>
            <p>
            <div class="row facet"><div class="col-md-12">@facets("Besitzende Bibliotheken", Application.ITEM_FIELD, owner, "dropup")</div></div>
            </p>
         </div>
      </div>
    }
}
